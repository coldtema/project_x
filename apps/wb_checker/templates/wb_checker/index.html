{% extends 'base.html' %}

{% block title %}WB Checker{% endblock title %}
{%load custom_math%}
{% block content %}
<div class="sticky top-4 z-40">
  <a href="{% url 'core:menu' %}" class="inline-flex items-center gap-2 px-3 py-1.5 bg-white dark:bg-neutral-800 rounded-full text-sm text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 border border-gray-300 dark:border-neutral-600 shadow-sm transition cursor-pointer group">
    <svg class="w-4 h-4 stroke-current group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
    </svg>
    –ù–∞–∑–∞–¥
  </a>
</div>
    <div class="max-w-6xl mx-auto py-8">
        <form method="POST" class="bg-white shadow-lg rounded-xl p-6 space-y-4 border-2 border-gray-300 dark:border-neutral-700 dark:bg-neutral-900">
            {% csrf_token %}
            <div class="space-y-4 text-gray-800 dark:text-white">
                <h1 class="text-xl font-bold mb-6 text-gray-800 dark:text-gray-200 text-center">–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞ WB</h1>
                {% for field in form %}
                    <div>
                        {{ field }}
                        {% if field.help_text %}
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ field.help_text }}</p>
                        {% endif %} 
                        {% if field.errors %}
                            <p class="text-sm text-red-500 mt-1">{{ field.errors|striptags }}</p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <div class="flex text-right justify-between py-2 rounded-md transition">
                <button type="submit" class="bg-blue-700 hover:bg-blue-800 text-white font-semibold px-4 py-2 rounded shadow transition">
                    –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
                </button>
                <span id='notif' class="text-sm font-semibold text-gray-800 dark:text-gray-200 items-center opacity-100 flex duration-300">
                    {%if messages%}
                        {%for message in messages%}
                            <h1>{{message}}</h1>
                        {%endfor%}
                        <!-- –§–æ—Ä–º–∞ -->
                    {%endif%}
                </span>
            </div>
        </form>


  <!-- –ë–ª–æ–∫ "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏" + —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
  <div class="mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 sm:gap-6 py-6">
    {% if disabled_prod_count > 0 %}
    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏" -->
        <a href="{%url 'wb_checker:disabled_prods'%}" class="relative inline-flex items-center text-sm font-medium text-blue-600 dark:text-blue-400 gap-1">
        üö´ –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
            <span
            class=" bg-red-600 text-white text-xs font-semibold rounded-full px-1.5 py-0.5 leading-none shadow">
            {{ disabled_prod_count }}
            </span>
        </a>
    {% endif %}

    <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
    <div class="flex items-center gap-2">
      <h2 class="text-lg font-semibold text-gray-800 dark:text-white">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</h2>
      <form method="get" class="flex gap-2">
        <select name="sort" onchange="this.form.submit()"
                class="text-sm rounded-md border border-gray-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 text-gray-700 dark:text-gray-200 px-3 py-1 focus:ring-blue-500 focus:border-blue-500 transition">
          <option value="" {% if request.GET.sort == '' %}selected{% endif %}>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
          <option value="price_asc" {% if request.GET.sort == 'price_asc'%}selected{% endif %}>üí∏ –¶–µ–Ω–µ ‚Üë</option>
          <option value="price_desc" {% if request.GET.sort == 'price_desc'%}selected{% endif %}>üí∏ –¶–µ–Ω–µ ‚Üì</option>
          <option value="discount" {% if request.GET.sort == 'discount' %}selected{% endif %}>üìâ –°–∫–∏–¥–∫–µ</option>
        </select>
      </form>
    </div>
  </div>
    
        <!-- –ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏ -->
        <div class="mt-8 flex flex-wrap gap-4">
            <a href="{% url 'wb_checker:clear_db' %}" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-blue-600 dark:text-blue-300 px-4 py-2 rounded-lg shadow text-sm">
                üßπ –û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É
            </a>
            <a href="{% url 'wb_checker:update_prices' %}" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-blue-600 dark:text-blue-300 px-4 py-2 rounded-lg shadow text-sm">
                üí∞ –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã
            </a>
            <a href="{% url 'wb_checker:update_avaliability' %}" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-blue-600 dark:text-blue-300 px-4 py-2 rounded-lg shadow text-sm">
                üì¶ –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ
            </a>
            <a href="{% url 'wb_checker:update_all_menu_categories' %}" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-blue-600 dark:text-blue-300 px-4 py-2 rounded-lg shadow text-sm">
                üóÇÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–µ–Ω—é
            </a>
            <a href="{% url 'wb_checker:update_top_prods' %}" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-blue-600 dark:text-blue-300 px-4 py-2 rounded-lg shadow text-sm">
                üîù –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ø –ø—Ä–æ–¥—É–∫—Ç—ã
            </a>
            <a href="{% url 'wb_checker:update_top_prods_info' %}" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-blue-600 dark:text-blue-300 px-4 py-2 rounded-lg shadow text-sm">
                üìù –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ—É –æ —Ç–æ–ø–∞—Ö
            </a>
            <a href="{% url 'wb_checker:recommendations' %}" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-blue-600 dark:text-blue-300 px-4 py-2 rounded-lg shadow text-sm">
                üéØ –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º
            </a>
            <a href="{% url 'accounts:update_discount_balance' %}" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-blue-600 dark:text-blue-300 px-4 py-2 rounded-lg shadow text-sm">
                –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å —Å–∫–∏–¥–æ–∫
            </a>
        </div>
    
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
        <div class="grid py-8 gap-4 sm:gap-4 xl:gap-10 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-4">
            {% for elem in prods %}
            <div class="prod_card relative bg-white dark:bg-neutral-900 rounded-xl overflow-hidden border border-gray-200 dark:border-neutral-700 hover:shadow transition flex flex-col flex-1 h-full pb-2">
                <form method='post'>
                    {% csrf_token %}
                    <button class="absolute top-2 right-2 flex items-center justify-center w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full text-xs z-10"
                            hx-post={%url 'wb_checker:delete_wb_product' id=elem.pk%}
                            hx-swap='delete'
                            hx-trigger='click'
                            hx-target='closest .prod_card'
                            name='delete_product'
                            value='1'
                            >‚úï
                    </button>
                </form>
              <!-- –°—Ç–∏–∫–µ—Ä —Å–∫–∏–¥–∫–∏ -->
              {% if elem.discount %}
              <div class="absolute top-1 left-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded z-10">
                -{{ elem.discount }}%
              </div>
              {% endif %}
        
              <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
              <div class="aspect-[4/5] w-full overflow-hidden">
                <img src="{{ elem.product.image_url }}" alt="{{ elem.product.name }}"
                     class="w-full h-full object-cover object-center" />
              </div>
        
              <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
              <div class="p-2 flex flex-col flex-1 space-y-1">
                <a href="{{ elem.product.url }}" target="_blank">
                    <h3 class="text-sm font-medium text-gray-900 dark:text-white line-clamp-3 leading-tight">
                    {{ elem.product.name }}
                    </h3>
                </a>
                {% if elem.product.rating %}
                <div class="flex items-center text-yellow-400 text-xs gap-0.5 mt-1">
                  <span class="text-sm leading-none">‚òÖ</span>
                  <span>{{ elem.product.rating }}</span>
                  {% if elem.product.feedbacks %}
                  <span class="text-[10px] text-gray-500 dark:text-gray-400">({{ elem.product.feedbacks }})</span>
                  {% endif %}
                </div>
                {% endif %}
            </div>

            <div class="text-sm px-2 font-bold text-gray-900 dark:text-gray-300 mt-1">{{ elem.latest_price }} ‚ÇΩ 
                {%if elem.latest_price < elem.first_price%}
                    (<span class="text-green-500 text-xs">‚Üì {{elem.first_price|minus:elem.latest_price}} ‚ÇΩ</span>)
                {%elif elem.latest_price > elem.first_price%}
                    (<span class="text-red-400 text-xs">‚Üë {{elem.latest_price|minus:elem.first_price}} ‚ÇΩ</span>)
                {%endif%}
            </div>
            <div class="text-sm px-2 font-bold text-gray-900 dark:text-gray-300 mt-1">
                <a href={%url 'wb_checker:wb_product_details' id=elem.id%}
                    class="mt-2 inline-block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-medium py-1 px-2 rounded transition text-xs">
                    –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                </a>
            </div>
            </div>
            {% endfor %}
          </div>
    </div>
    
        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <div class="mt-10">
            {% include "wb_checker/pagination.html" with page=prods page_range=page_range request=request.GET%}
        </div>
    </div>
    <script>
        setTimeout(() => {
            const el = document.getElementById('notif');
            el.classList.remove('opacity-100');
            el.classList.add('opacity-0');
        }, 3000); 
    </script>
</div>
{% endblock content %}
